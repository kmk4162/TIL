# 10/24

## ğŸŸ¨ Many to many relationship

### ğŸ§© ê°œìš”

ë³‘ì› ì˜ˆì•½ ì‹œìŠ¤í…œ êµ¬ì¶•ì„ ìœ„í•œ ë°ì´í„° ë² ì´ìŠ¤ ëª¨ë¸ë§ì„ ì§„í–‰í•œë‹¤ë©´?

> í™˜ì, ì§„ë£Œê³¼ëª©, ì˜ì‚¬ ë“±ë“±...

í™˜ì : ì˜ì‚¬ = n : 1ì´ ê°€ëŠ¥í•œë° ë¬¸ì œëŠ” ì˜ì‚¬ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•¨...

**ì¦‰, n:1ì˜ í•œê³„!**

<br>

### ğŸ§© N:1ì˜ í•œê³„

ë™ì¼í•œ í™˜ìì§€ë§Œ ë‹¤ë¥¸ ì˜ì‚¬ì—ê²Œ ì˜ˆì•½í•˜ê¸° ìœ„í•´ì„œëŠ” ê°œì²´ë¥¼ í•˜ë‚˜ ë” ë§Œë“¤ì–´ì„œ ì˜ˆì•½ì„ ì§„í–‰í•´ì•¼í•¨(ì˜ì‚¬ëŠ” 1ì´ë‹ˆê¹Œ)

ì™¸ë˜í‚¤ ì¹¼ëŸ¼ì— '1, 2' í˜•íƒœë¡œ ì°¸ì¡°í•˜ëŠ” ê²ƒì€ **Integer** íƒ€ì…ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ë¶ˆê°€ëŠ¥

> ì˜ˆì•½ í…Œì´ë¸”ì„ ë”°ë¡œ ë§Œë“¤ì!

![image-20221027024825635](Django_221024.assets/image-20221027024825635.png)

> doctor_idê°€ ì˜ì‚¬, patient_idê°€ í™˜ìì¼ ë•Œ
>
> 1ë²ˆ í™˜ìê°€ 1ë²ˆ ì˜ì‚¬ì—ê²Œ, 2ë²ˆ í™˜ìê°€ 1ë²ˆ ì˜ì‚¬ì—ê²Œ ì§„ë£Œë°›ìŒì„ í™•ì‹¤í•˜ê²Œ í‘œí˜„í•  ìˆ˜ ìˆìŒ!
>
> ì´ëŸ°ì‹ìœ¼ë¡œ í•˜ë©´ ì˜ˆì•½ì´ ë“¤ì–´ì˜¬ ë•Œ ë§ˆë‹¤ reservation í…Œì´ë¸”ì— ê³„ì† ë°ì´í„°ê°€ ìƒì„±ë˜ëŠ” ë°©ì‹

ê·¸ëŸ°ë° ì¥ê³ ì—ì„œëŠ” ì´ëŸ°ì‹ìœ¼ë¡œ ì§„í–‰í•˜ì§€ëŠ” ì•ŠìŒ! ì™œëƒë©´ ë” ì¢‹ì€ í•„ë“œê°€ ì´ë¯¸ ë‚´ì¥ë¼ìˆê¸° ë•Œë¬¸!

<br>

### ğŸ§© ManyToManyField

```python
# hospitals/models.py

class Patient(models.Model):
    # ManyToManyField ì‘ì„±
    doctors = models.ManyToManyField(Doctor)
    name = models.TextField()
    
    def __str__(self):
    return f'{self.pk}ë²ˆ í™˜ì {self.name}â€™
```

```shell
# patient1ì´ doctor1ì—ê²Œ ì˜ˆì•½
patient1.doctors.add(doctor1)

# patient1 - ìì‹ ì´ ì˜ˆì•½í•œ ì˜ì‚¬ëª©ë¡ í™•ì¸
patient1.doctors.all()
<QuerySet [<Doctor: 1ë²ˆ ì˜ì‚¬ alice>]>

# doctor1 - ìì‹ ì˜ ì˜ˆì•½ëœ í™˜ìëª©ë¡ í™•ì¸
doctor1.patient_set.all() 
<QuerySet [<Patient: 1ë²ˆ í™˜ì carol>]>
```

> ëª…ë ¹ì–´ë„ ì´ì œ **add**ë¡œ ë°”ë€œ
>
> manytomanyë¥¼ ì“°ë©´ ì—­ì°¸ì¡°ê°€ í›¨ì”¬ ì‰¬ì›Œì§

```shell
# patient1ì´ doctor1ì—ê²Œ ì˜ˆì•½
patient1.doctors.add(doctor1)
# patient1 - ìì‹ ì´ ì˜ˆì•½í•œ ì˜ì‚¬ëª©ë¡ í™•ì¸
patient1.doctors.all()
<QuerySet [<Doctor: 1ë²ˆ ì˜ì‚¬ alice>]>
# doctor1 - ìì‹ ì˜ ì˜ˆì•½ëœ í™˜ìëª©ë¡ í™•ì¸
doctor1.patient_set.all() 
<QuerySet [<Patient: 1ë²ˆ í™˜ì carol>]>
```

> í™˜ìê°€ ì˜ì‚¬ì—ê²Œ ì˜ˆì•½ì„ í•˜ê±°ë‚˜

```shell
# doctor1ì´ patient2ì„ ì˜ˆì•½
doctor1.patient_set.add(patient2)
# doctor1 - ìì‹ ì˜ ì˜ˆì•½ í™˜ìëª©ë¡ í™•ì¸
doctor1.patient_set.all() 
<QuerySet [<Patient: 1ë²ˆ í™˜ì carol>, <Patient: 2ë²ˆ í™˜ì dane>]>
# patient1, 2 - ìì‹ ì´ ì˜ˆì•½í•œ ì˜ì‚¬ëª©ë¡ í™•ì¸
patient1.doctors.all()
<QuerySet [<Doctor: 1ë²ˆ ì˜ì‚¬ alice>]>
patient2.doctors.all()
<QuerySet [<Doctor: 1ë²ˆ ì˜ì‚¬ alice>]>
```

> ì˜ì‚¬ê°€ í™˜ìë¥¼ ì˜ˆì•½ì„ í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥

> í•œë§ˆë””ë¡œ, ManyToManyFieldì„ ì‚¬ìš©í•˜ë©´ ì¤‘ê°œ í…Œì´ë¸”ì´ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ë‹¤!

<br>

### ğŸ§© related_name argument

target modelì´ source modelì„ ì°¸ì¡°í•  ë•Œ ì‚¬ìš©í•  manager name

ForeignKey()ì˜ related_nameê³¼ ë™ì¼

**ManyToManyFieldì—ì„œëŠ” ê±°ì˜ í•„ìˆ˜ì ìœ¼ë¡œ í•´ì£¼ëŠ”ê²Œ ì¢‹ìŒ**

```python
class Patient(models.Model):
    # ManyToManyField - related_name ì‘ì„±
    doctors = models.ManyToManyField(Doctor, related_name='patients')
    name = models.TextField()
    
    def __str__(self):
    	return f'{self.pk}ë²ˆ í™˜ì {self.name}'
```

> related_nameì„ patientsë¼ê³  ì§€ì •í•´ì¤¬ìœ¼ë¯€ë¡œ
>
> ì´ì œ 1ë²ˆì˜ì‚¬ì˜ ëª¨ë“  í™˜ìë¥¼ ë³´ëŠ” ëª…ë ¹ì–´ëŠ”
>
> Doctor.objects.get(pk=1).patient_set.all()ì´ ì•„ë‹ˆê³ 
>
> Doctor.objects.get(pk=1).patients.all()ë¡œ ë°”ë€œ!

<br>

### ğŸ§© â€˜throughâ€™ argument

ì¤‘ê°œ í…Œì´ë¸”ì„ ì§ì ‘ ì§€ì •í•˜ë ¤ëŠ” ê²½ìš° through ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©í•˜ë ¤ëŠ” ì¤‘ê°œ í…Œì´ë¸”ì„ ë‚˜íƒ€ë‚´ëŠ” Django ëª¨ë¸ì„ ì§€ì •í•  ìˆ˜ ìˆìŒ

ê°€ì¥ ì¼ë°˜ì ì¸ ìš©ë„ëŠ” ì¤‘ê°œí…Œì´ë¸”ì— ì¶”ê°€ ë°ì´í„°ë¥¼ ì‚¬ìš©í•´ ë‹¤ëŒ€ë‹¤ ê´€ê³„ì™€ ì—°ê²°í•˜ë ¤ëŠ” ê²½ìš°

```python
class Patient(models.Model):
    doctors = models.ManyToManyField(Doctor, through='Reservation')
    name = models.TextField()
    
    def __str__(self):
    	return f'{self.pk}ë²ˆ í™˜ì {self.name}'
    
class Reservation(models.Model):
    doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE)
    symptom = models.TextField()
    reserved_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
    	return f'{self.doctor.pk}ë²ˆ ì˜ì‚¬ì˜ {self.patient.pk}ë²ˆ í™˜ì'
```

> ì˜ˆì•½ì •ë³´(Reservation)ì— ì¦ìƒ(symptom)ê³¼ ì˜ˆì•½ì¼(reserved_at)ì´ë¼ëŠ” ì¶”ê°€ ë°ì´í„°ê°€ ìƒê¹€

<br>

## ğŸŸ¨ ì¢‹ì•„ìš” ê¸°ëŠ¥

### ğŸ§© ê°œìš”, ìƒê°...

Article : UserëŠ” M : N

Articleì€ 0ëª… ì´ìƒì˜ Userì—ê²Œ ì¢‹ì•„ìš”ë¥¼ ë°›ëŠ”ë‹¤.

UserëŠ” 0ê°œ ì´ìƒì˜ ê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¼ ìˆ˜ ìˆë‹¤.

**ìƒì„¸ë³´ê¸° í˜ì´ì§€**ì—ì„œ ì¢‹ì•„ìš” ë§í¬ë¥¼ ëˆ„ë¥´ë©´, ì¢‹ì•„ìš”ë¥¼ DBì— ì¶”ê°€í•˜ê³  ë‹¤ì‹œ ìƒì„¸ë³´ê¸° í˜ì´ì§€ë¡œ redirect!

<br>

### ğŸ§© ëª¨ë¸ ê´€ê³„ ì„¤ì •

ManyToManyField ì‘ì„±

```python
# articles/models.py

class Article(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
    like_users = models.ManyToManyField(settings.AUTH_USER_MODEL)
    title = models.CharField(max_length=10)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

like_users í•„ë“œ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ì—­ì°¸ì¡°ì—ëŠ” **article_set ë§¤ë‹ˆì €**ê°€ ìƒì„±ë¨

**ê·¸ëŸ¬ë‚˜ ì´ì „ N:1(Article-User) ê´€ê³„ì—ì„œ ì´ë¯¸ í•´ë‹¹ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš© ì¤‘**

- user.article_set.all() ğŸ‘‰ **í•´ë‹¹ ìœ ì €ê°€ ì‘ì„±í•œ ëª¨ë“  ê²Œì‹œê¸€ ì¡°íšŒ**
- **userê°€ ì‘ì„±í•œ ê¸€ë“¤**(user.article_set)ê³¼ **userê°€ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê¸€**(user.article_set)ì„ êµ¬ë¶„í•  ìˆ˜ ì—†ê²Œ ë¨

> userì™€ ê´€ê³„ëœ ForeignKey í˜¹ì€ ManyToManyField ì¤‘ í•˜ë‚˜ì— related_nameì„ ì‘ì„±í•´ì•¼ í•¨

<br>

```python
# articles/models.py

class Article(models.Model):
	user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
	like_users = models.ManyToManyField(settings.AUTH_USER_MODEL, related_name='like_articles')
	title = models.CharField(max_length=10)
	content = models.TextField()
	created_at = models.DateTimeField(auto_now_add=True)
	updated_at = models.DateTimeField(auto_now=True)
```

> like_usersì— **related_name='like_articles'** ì¶”ê°€í•¨!

![image-20221101221755646](Django_221024.assets/image-20221101221755646.png)

> ì¤‘ê°œ í…Œì´ë¸”ì— article_idì™€ user_idê°€ ì¶”ê°€ë¨

<br>

### ğŸ§© ì¢‹ì•„ìš” êµ¬í˜„

```python
# articles/urls.py

urlpatterns = [
    ...
    path('<int:article_pk>/likes/', views.likes, name='likes'),
]
```

```python
# articles/views.py

def likes(request, article_pk):
    article = Article.objects.get(pk=article_pk)
    if article.like_users.filter(pk=reqeust.user.pk).exists():
        article.like_users.remove(request.user)
    else:
        article.like_users.add(request.user)
    return redirect('articles:index')
```

> article.like_users.allì— ìˆëŠ” userë¼ë©´ ì´ë¯¸ ì´ ê²Œì‹œê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ë‹¤ëŠ” ëœ»ì´ë¯€ë¡œ article.like_usersì—ì„œ ì§€ìš´ë‹¤!

QuerySetì— ê²°ê³¼ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ Trueë¥¼ ë°˜í™˜í•˜ê³  ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ Falseë¥¼ ë°˜í™˜

íŠ¹íˆ í° QuerySetì— ìˆëŠ” íŠ¹ì • ê°œì²´ì˜ ì¡´ì¬ì™€ ê´€ë ¨ëœ ê²€ìƒ‰ì— ìœ ìš©

```django
<!-- articles/index.html -->
{% extends 'base.html' %}
{% block content %}
â€¦
{% for article in articles %}
â€¦
<div>
    <form action="{% url 'articles:likes' article.pk %}" method="POST">
    {% csrf_token %}
    {% if request.user in article.like_users.all %}
    <input type="submit" value="ì¢‹ì•„ìš” ì·¨ì†Œ">
    {% else %}
    <input type="submit" value="ì¢‹ì•„ìš”">
    {% endif %}
    </form>
</div>
<a href="{% url 'articles:detail' article.pk %}">DETAIL</a>
<hr>
{% endfor %}
{% endblock content %}
```

> ê° ê²Œì‹œê¸€ì— ì¢‹ì•„ìš” ë²„íŠ¼ ì¶œë ¥í•˜ê¸°

<br>

